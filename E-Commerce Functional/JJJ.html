<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced E-commerce Pro - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply antialiased bg-slate-100 text-slate-700; 
            scroll-behavior: smooth;
        }
        .nav-link {
            @apply px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-indigo-100 hover:text-indigo-700 transition-all duration-300 ease-in-out relative; /* Added relative for pseudo-element */
        }
        .nav-link::after { 
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 2px;
            background-color: theme('colors.indigo.600');
            transition: all 0.3s ease-in-out;
            transform: translateX(-50%);
        }
        .nav-link:hover::after,
        .nav-link-active::after {
            width: 60%;
        }
        .nav-link-active {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 hover:text-white;
        }
        .product-card {
            @apply bg-white shadow-lg rounded-xl overflow-hidden transition-all duration-300 hover:shadow-2xl relative flex flex-col transform hover:-translate-y-1; /* Added transform */
        }
        .product-card img {
            @apply transition-transform duration-300;
        }
        .btn { 
            @apply px-5 py-2.5 rounded-lg font-semibold text-sm shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-300 ease-in-out transform hover:scale-[1.02];
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500;
        }
        .btn-secondary {
            @apply bg-slate-200 text-slate-700 hover:bg-slate-300 focus:ring-slate-400;
        }
        .btn-danger {
            @apply bg-red-500 text-white hover:bg-red-600 focus:ring-red-400;
        }
        .btn-outline {
            @apply bg-transparent border border-indigo-600 text-indigo-600 hover:bg-indigo-50;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700 focus:ring-green-500;
        }
        .page-section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .page-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-75 backdrop-blur-md flex items-center justify-center p-4 z-[100]; /* Increased backdrop-blur */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            @apply bg-white p-6 rounded-xl shadow-2xl w-full max-h-[90vh] overflow-y-auto transition-transform duration-300 ease-out scale-95 opacity-0;
        }
        .modal.open .modal-content {
            @apply scale-100 opacity-100;
        }
        .form-input {
            @apply mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-all duration-200 ease-in-out; /* Added transition */
        }
        .form-input:focus {
            box-shadow: 0 0 0 3px theme('colors.indigo.200'); 
        }
        .form-label {
            @apply block text-sm font-medium text-slate-700 mb-1;
        }
        .form-radio {
            @apply appearance-none w-5 h-5 border-2 border-slate-300 rounded-full focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 checked:bg-indigo-600 checked:border-transparent relative;
        }
        .form-radio:checked::after {
            content: '';
            @apply w-2.5 h-2.5 bg-white rounded-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2;
        }


        /* Wishlist Icon Enhanced */
        .wishlist-btn .fa-heart {
            transition: color 0.2s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Springy transform */
        }
        .wishlist-btn.active .fa-heart {
            color: #ef4444; /* red-500 */
            transform: scale(1.2);
        }

        /* Star Rating */
        .star-rating .fa-star, .star-rating .fa-star-half-alt {
            color: #f59e0b; /* amber-500 */
            transition: transform 0.2s ease;
        }
        .star-rating:hover .fa-star, .star-rating:hover .fa-star-half-alt {
            transform: scale(1.1);
        }
        .star-rating .text-slate-300 {
             color: #cbd5e1;
        }

        /* Toast Notification Enhanced */
        #toast-notification {
            @apply fixed bottom-8 right-8 px-6 py-4 rounded-xl shadow-xl text-white text-sm font-medium z-[200] transition-all duration-500 ease-in-out transform;
            transform: translateX(120%) translateY(0); /* Start off-screen right and slightly up */
            opacity: 0;
        }
        #toast-notification.show {
            transform: translateX(0) translateY(0);
            opacity: 1;
        }

        /* Product card image container */
        .product-image-container {
            @apply w-full h-56 overflow-hidden bg-slate-200 rounded-t-xl; /* Rounded top corners for image container */
        }
        .product-image-container img {
            @apply w-full h-full object-cover transition-transform duration-500 ease-in-out;
        }
        .product-card:hover .product-image-container img {
            transform: scale(1.05); /* Subtle zoom on hover */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px) scale(0.98); } /* Added scale */
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .product-card-animated {
            animation: fadeIn 0.6s ease-out forwards;
        }

        /* Book Detail Page Specific Styles */
        .book-cover-container {
            @apply bg-slate-100 p-4 sm:p-6 rounded-lg shadow-md flex justify-center items-center;
        }
        .book-cover-container img {
            max-height: 500px;
            @apply rounded-md shadow-lg transition-transform duration-300 hover:scale-105;
        }
        .detail-section-title {
            @apply text-2xl font-semibold text-slate-800 mb-4 border-b-2 border-indigo-200 pb-2; /* Accent border */
        }
        .review-card {
            @apply bg-slate-50 p-4 rounded-lg border border-slate-200 hover:shadow-md transition-shadow duration-200;
        }

        /* Skeleton Loader for products */
        .skeleton-card {
            @apply bg-white shadow-lg rounded-xl overflow-hidden p-5 space-y-4;
        }
        .skeleton-image { @apply h-48 bg-slate-200 rounded-md animate-pulse; }
        .skeleton-line { @apply h-4 bg-slate-200 rounded animate-pulse; }


        /* Enhanced active state for account page navigation */
        .account-nav-link.active {
            @apply bg-indigo-100 text-indigo-700 border-l-4 border-indigo-600 font-semibold;
        }
        .account-nav-link {
            @apply block p-3 rounded-lg hover:bg-indigo-50 text-slate-600 hover:text-indigo-700 transition-colors duration-200;
        }

        /* Quantity input buttons */
        .quantity-control button {
            @apply w-8 h-8 bg-slate-200 text-slate-600 rounded-md hover:bg-slate-300 transition-colors duration-150 flex items-center justify-center;
        }
        .quantity-control input {
            @apply w-16 text-center border-x-0 border-slate-300 focus:ring-0 focus:border-slate-300;
        }

        /* Hero section pattern (subtle) */
        .bg-pattern-hero {
            background-image: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Added spinning loader */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4f46e5; /* Indigo */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-slate-100">

    <header class="bg-white shadow-md sticky top-0 z-50 transition-shadow duration-300"> <nav class="container mx-auto px-4 lg:px-8 py-3.5"> <div class="flex items-center justify-between">
                <a href="#home" id="logo" class="text-3xl font-bold text-indigo-600 flex items-center transition-transform duration-200 hover:scale-105">
                    <i class="fas fa-shopping-bag mr-2 transform group-hover:rotate-[-5deg] transition-transform duration-300"></i>ProShop
                </a>

                <div class="hidden md:flex items-center space-x-1"> <a href="#home" class="nav-link nav-link-active" data-page="home">Home</a>
                    <a href="#products" class="nav-link" data-page="products">Products</a>
                    <a href="#about" class="nav-link" data-page="about">About</a>
                    <a href="#contact" class="nav-link" data-page="contact">Contact</a>
                </div>

                <div class="flex items-center space-x-3"> <div class="relative hidden sm:block group">
                        <input type="text" id="desktop-search-input" placeholder="Search..." class="form-input py-2 pl-10 pr-3 w-40 lg:w-56 focus:w-64 lg:focus:w-72 transition-all duration-300 ease-in-out"> <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors duration-200">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <a href="#cart" class="nav-link relative group" data-page="cart" aria-label="View Shopping Cart"> <i class="fas fa-shopping-cart text-xl text-slate-600 group-hover:text-indigo-700 transition-colors duration-200"></i>
                        <span id="cart-item-count" class="absolute -top-2 -right-2.5 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-semibold transition-transform duration-200 transform scale-100">0</span> </a>
                    <a href="#account" class="nav-link group" data-page="account" aria-label="My Account"> <i class="fas fa-user text-xl text-slate-600 group-hover:text-indigo-700 transition-colors duration-200"></i>
                    </a>
                    <button id="mobile-menu-button" class="md:hidden text-slate-700 hover:text-indigo-600 focus:outline-none p-2 rounded-md hover:bg-indigo-50 transition-colors duration-200" aria-label="Open menu" aria-expanded="false"> <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden mt-3 space-y-1 border-t border-slate-200 pt-3"> <a href="#home" class="block nav-link nav-link-active" data-page="home">Home</a>
                <a href="#products" class="block nav-link" data-page="products">Products</a>
                <a href="#about" class="block nav-link" data-page="about">About Us</a>
                <a href="#contact" class="block nav-link" data-page="contact">Contact Us</a>
                <div class="relative mt-2 px-2">
                     <input type="text" id="mobile-search-input" placeholder="Search products..." class="form-input w-full pl-10 py-2.5"> <span class="absolute left-5 top-1/2 transform -translate-y-1/2 text-slate-400"> <i class="fas fa-search"></i>
                     </span>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 lg:px-8 py-8 min-h-[calc(100vh-280px)]">
        <section id="home" class="page-section active">
            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white py-28 px-8 rounded-xl shadow-2xl text-center mb-16 relative overflow-hidden"> <div class="absolute inset-0 opacity-10 bg-pattern-hero"></div> <h1 class="text-5xl md:text-6xl font-extrabold mb-6 tracking-tight animate-fadeInUp" style="animation-delay: 0.2s;">Welcome to ProShop</h1>
                <p class="text-xl md:text-2xl mb-10 max-w-2xl mx-auto text-indigo-100 animate-fadeInUp" style="animation-delay: 0.4s;">Your ultimate destination for premium products and unbeatable deals.</p>
                <a href="#products" data-page="products" class="btn bg-white text-indigo-700 hover:bg-indigo-50 text-lg px-10 py-3.5 transform hover:scale-105 animate-fadeInUp" style="animation-delay: 0.6s;">
                    <i class="fas fa-tags mr-2"></i>Explore Collection
                </a>
            </div>
            <style> /* Animation for home page elements */
                @keyframes fadeInUp {
                    from { opacity: 0; transform: translateY(30px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-fadeInUp { animation: fadeInUp 0.8s ease-out forwards; }
            </style>

            <section class="mb-16">
                <h2 class="text-3xl font-bold text-slate-800 mb-10 text-center">Featured Categories</h2> <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="group bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center cursor-pointer transform hover:-translate-y-1.5" data-category-filter="Electronics" style="animation-delay: 0s; opacity:0;" data-animate-on-scroll>
                        <i class="fas fa-laptop-code text-5xl text-indigo-500 mb-4 group-hover:text-indigo-600 transition-colors duration-300 transform group-hover:scale-110"></i>
                        <h3 class="text-xl font-semibold text-slate-700">Electronics</h3>
                    </div>
                    <div class="group bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center cursor-pointer transform hover:-translate-y-1.5" data-category-filter="Apparel" style="animation-delay: 0.1s; opacity:0;" data-animate-on-scroll>
                        <i class="fas fa-tshirt text-5xl text-pink-500 mb-4 group-hover:text-pink-600 transition-colors duration-300 transform group-hover:scale-110"></i>
                        <h3 class="text-xl font-semibold text-slate-700">Apparel</h3>
                    </div>
                    <div class="group bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center cursor-pointer transform hover:-translate-y-1.5" data-category-filter="Home Goods" style="animation-delay: 0.2s; opacity:0;" data-animate-on-scroll>
                        <i class="fas fa-couch text-5xl text-green-500 mb-4 group-hover:text-green-600 transition-colors duration-300 transform group-hover:scale-110"></i>
                        <h3 class="text-xl font-semibold text-slate-700">Home Goods</h3>
                    </div>
                    <div class="group bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center cursor-pointer transform hover:-translate-y-1.5" data-category-filter="Books" style="animation-delay: 0.3s; opacity:0;" data-animate-on-scroll>
                        <i class="fas fa-book-reader text-5xl text-amber-500 mb-4 group-hover:text-amber-600 transition-colors duration-300 transform group-hover:scale-110"></i>
                        <h3 class="text-xl font-semibold text-slate-700">Books</h3>
                    </div>
                </div>
            </section>

            <section>
                <h2 class="text-3xl font-bold text-slate-800 mb-10 text-center">Hot Deals</h2> <div id="featured-products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-10"> </div>
                <div id="featured-loader" class="loader hidden"></div>
            </section>
        </section>

        <section id="products" class="page-section">
            <h1 class="text-4xl font-extrabold text-slate-800 mb-10">Our Collection</h1>
            <div class="mb-8 p-6 bg-white rounded-xl shadow-lg sticky top-[70px] z-10"> <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end"> <div>
                        <label for="category-filter" class="form-label">Filter by Category</label>
                        <select id="category-filter" class="form-input">
                            <option value="all">All Categories</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Apparel">Apparel</option>
                            <option value="Home Goods">Home Goods</option>
                            <option value="Books">Books</option>
                            <option value="Sports">Sports</option>
                        </select>
                    </div>
                    <div>
                        <label for="sort-filter" class="form-label">Sort By</label>
                        <select id="sort-filter" class="form-input">
                            <option value="default">Default</option>
                            <option value="price-asc">Price: Low to High</option>
                            <option value="price-desc">Price: High to Low</option>
                            <option value="name-asc">Name: A to Z</option>
                            <option value="name-desc">Name: Z to A</option>
                            <option value="rating-desc">Rating: High to Low</option> </select>
                    </div>
                    <div class="md:col-span-1">
                        <label for="main-search-input" class="form-label">Search Products</label>
                         <div class="relative">
                            <input type="text" id="main-search-input" placeholder="Name, tag, or description..." class="form-input pl-10"> <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                    </div>
                    <div class="md:col-span-1">
                         <button id="clear-filters-btn" class="btn btn-secondary w-full text-sm"><i class="fas fa-times mr-2"></i>Clear Filters</button>
                    </div>
                </div>
            </div>
            <div id="all-products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-10"> </div>
            <div id="products-loader" class="loader hidden"></div>
            <p id="no-products-message" class="text-center text-slate-500 py-12 text-lg hidden">
                <i class="fas fa-box-open text-4xl text-slate-400 mb-3"></i><br>
                No products match your criteria. Try adjusting your filters!
            </p>
        </section>

        <section id="cart" class="page-section">
            <h1 class="text-4xl font-extrabold text-slate-800 mb-10">Your Shopping Cart</h1>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div id="cart-items-container" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg min-h-[200px]"> <p id="cart-empty-message" class="text-slate-500 py-8 text-center text-lg">
                        <i class="fas fa-shopping-cart text-4xl text-slate-400 mb-4"></i><br>
                        Your cart is looking a little empty. <br><a href="#products" data-page="products" class="text-indigo-600 hover:underline font-semibold">Start shopping!</a>
                    </p>
                    </div>
                <div id="cart-summary-container" class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-lg sticky top-24">
                        <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-3">Order Summary</h2>
                        <div id="cart-summary" class="space-y-3 hidden">
                            <div class="flex justify-between text-slate-600">
                                <span>Subtotal (<span id="cart-summary-item-count">0</span> items):</span>
                                <span id="cart-subtotal" class="font-semibold text-slate-800">$0.00</span>
                            </div>
                            <div class="flex justify-between text-slate-600">
                                <span>Shipping:</span>
                                <span class="font-semibold text-green-600">FREE</span>
                            </div>
                             <div class="flex justify-between text-slate-500 text-sm items-center mt-2" id="discount-applied-row" style="display: none;">
                                <span>Discount (<span id="discount-code-applied"></span>):</span>
                                <span id="cart-discount-amount" class="font-semibold text-red-500">-$0.00</span>
                            </div>
                            <hr class="my-3">
                            <div class="flex justify-between font-bold text-xl text-slate-800">
                                <span>Total:</span>
                                <span id="cart-total">$0.00</span>
                            </div>
                            <div class="mt-4 pt-4 border-t">
                                <label for="promo-code" class="form-label text-sm">Have a promo code?</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="promo-code" placeholder="Enter code" class="form-input form-input-sm flex-grow">
                                    <button id="apply-promo-btn" class="btn btn-outline text-sm px-4">Apply</button>
                                </div>
                                <p id="promo-feedback" class="text-xs mt-1.5"></p>
                            </div>
                            <button data-page="checkout" id="proceed-checkout-btn" class="btn btn-primary w-full mt-6 text-base">
                                <i class="fas fa-shield-alt mr-2"></i>Proceed to Secure Checkout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="checkout" class="page-section">
            <h1 class="text-4xl font-extrabold text-slate-800 mb-10">Checkout</h1>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-slate-800 mb-6">Shipping Details</h2>
                    <form id="shipping-form" class="space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label for="first-name" class="form-label">First Name <span class="text-red-500">*</span></label>
                                <input type="text" id="first-name" name="first-name" required class="form-input" aria-describedby="firstNameError">
                                <p id="firstNameError" class="text-red-500 text-xs mt-1 hidden">First name is required.</p>
                            </div>
                            <div>
                                <label for="last-name" class="form-label">Last Name <span class="text-red-500">*</span></label>
                                <input type="text" id="last-name" name="last-name" required class="form-input" aria-describedby="lastNameError">
                                <p id="lastNameError" class="text-red-500 text-xs mt-1 hidden">Last name is required.</p>
                            </div>
                        </div>
                        <div>
                            <label for="email" class="form-label">Email Address <span class="text-red-500">*</span></label>
                            <input type="email" id="email" name="email" required class="form-input" aria-describedby="emailError">
                            <p id="emailError" class="text-red-500 text-xs mt-1 hidden">Please enter a valid email.</p>
                        </div>
                        <div>
                            <label for="address" class="form-label">Street Address <span class="text-red-500">*</span></label>
                            <input type="text" id="address" name="address" required class="form-input" aria-describedby="addressError">
                            <p id="addressError" class="text-red-500 text-xs mt-1 hidden">Street address is required.</p>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <div>
                                <label for="city" class="form-label">City <span class="text-red-500">*</span></label>
                                <input type="text" id="city" name="city" required class="form-input">
                            </div>
                            <div>
                                <label for="state" class="form-label">State / Province</label>
                                <input type="text" id="state" name="state" class="form-input">
                            </div>
                            <div>
                                <label for="zip" class="form-label">ZIP / Postal Code <span class="text-red-500">*</span></label>
                                <input type="text" id="zip" name="zip" required class="form-input">
                            </div>
                        </div>
                        <div>
                            <label for="country" class="form-label">Country <span class="text-red-500">*</span></label>
                            <select id="country" name="country" class="form-input">
                                <option>United States</option>
                                <option>Canada</option>
                                <option>United Kingdom</option>
                                <option>Australia</option>
                                <option>Pakistan</option>
                                </select>
                        </div>
                        <div>
                            <label for="phone" class="form-label">Phone Number (Optional)</label>
                            <input type="tel" id="phone" name="phone" class="form-input">
                        </div>
                         <div class="flex items-start mt-4">
                            <input id="save-address" name="save-address" type="checkbox" class="h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 mt-0.5">
                            <div class="ml-3 text-sm">
                                <label for="save-address" class="font-medium text-slate-700">Save this information for next time</label>
                            </div>
                        </div>
                        <div class="pt-4">
                            <h2 class="text-2xl font-semibold text-slate-800 mb-6">Payment Method</h2>
                            <div class="space-y-4">
                                <div class="p-4 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 transition-all duration-200">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="payment" value="card" class="form-radio h-5 w-5 text-indigo-600 focus:ring-indigo-500 mr-3" checked>
                                        <i class="fas fa-credit-card text-indigo-600 text-xl mr-3"></i>
                                        <span class="font-medium">Credit or Debit Card</span>
                                    </label>
                                     <div class="mt-4 space-y-3" id="card-details-form" style="display: block;">
                                        <div>
                                            <label for="card-number" class="form-label text-xs">Card Number</label>
                                            <input type="text" id="card-number" placeholder="•••• •••• •••• ••••" class="form-input form-input-sm">
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label for="card-expiry" class="form-label text-xs">Expiry (MM/YY)</label>
                                                <input type="text" id="card-expiry" placeholder="MM/YY" class="form-input form-input-sm">
                                            </div>
                                            <div>
                                                <label for="card-cvc" class="form-label text-xs">CVC</label>
                                                <input type="text" id="card-cvc" placeholder="•••" class="form-input form-input-sm">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 transition-all duration-200">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="payment" value="paypal" class="form-radio h-5 w-5 text-indigo-600 focus:ring-indigo-500 mr-3">
                                        <i class="fab fa-paypal text-blue-600 text-xl mr-3"></i>
                                        <span class="font-medium">PayPal</span>
                                    </label>
                                </div>
                                 <div class="p-4 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 transition-all duration-200">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="payment" value="cod" class="form-radio h-5 w-5 text-indigo-600 focus:ring-indigo-500 mr-3">
                                        <i class="fas fa-truck text-green-600 text-xl mr-3"></i>
                                        <span class="font-medium">Cash on Delivery (COD)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-1">
                     <div class="bg-white p-6 rounded-xl shadow-lg sticky top-24">
                        <h2 class="text-2xl font-semibold text-slate-800 mb-6 border-b pb-3">Your Order</h2>
                        <div id="checkout-order-summary" class="space-y-3 mb-6 max-h-60 overflow-y-auto fancy-scrollbar">
                            <p class="text-slate-500">Loading your order...</p>
                        </div>
                        <div class="space-y-2 border-t pt-4">
                             <div class="flex justify-between text-slate-600">
                                <span>Subtotal:</span>
                                <span id="checkout-subtotal" class="font-semibold text-slate-800">$0.00</span>
                            </div>
                            <div class="flex justify-between text-slate-600" id="checkout-discount-row" style="display: none;">
                                <span>Discount:</span>
                                <span id="checkout-discount-amount" class="font-semibold text-red-500">-$0.00</span>
                            </div>
                            <div class="flex justify-between text-slate-600">
                                <span>Shipping:</span>
                                <span class="font-semibold text-green-600">FREE</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold text-xl text-slate-800">
                                <span>Grand Total:</span>
                                <span id="checkout-total">$0.00</span>
                            </div>
                        </div>
                        <button type="submit" form="shipping-form" id="place-order-btn" class="btn btn-primary w-full mt-8 text-base">
                            <span class="place-order-text"><i class="fas fa-lock mr-2"></i>Place Order & Pay</span>
                            <span class="place-order-loader hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Processing...</span>
                        </button>
                        <p class="text-xs text-slate-500 mt-3 text-center">By placing your order, you agree to our <a href="#" class="underline hover:text-indigo-600">Terms & Conditions</a>.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="thank-you" class="page-section text-center py-16">
            <div class="bg-white p-10 md:p-16 rounded-xl shadow-2xl max-w-2xl mx-auto transform scale-95 opacity-0" id="thank-you-card-content">
                <div id="confetti-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
                <i class="fas fa-check-circle text-6xl text-green-500 mb-6 transform scale-0" id="thank-you-check"></i>
                <h1 class="text-4xl font-extrabold text-slate-800 mb-4">Thank You For Your Order!</h1>
                <p class="text-lg text-slate-600 mb-2">Your order has been placed successfully.</p>
                <p class="text-slate-500 mb-6">A confirmation email has been sent to <strong id="thank-you-email" class="text-slate-700">your.email@example.com</strong>.</p>
                <div class="bg-slate-50 p-6 rounded-lg my-8 text-left">
                    <h3 class="text-xl font-semibold text-slate-700 mb-3">Order Summary</h3>
                    <p class="text-sm text-slate-600">Order ID: <span id="thank-you-order-id" class="font-medium">#PRO12345XYZ</span></p>
                    <p class="text-sm text-slate-600">Date: <span id="thank-you-order-date" class="font-medium">May 16, 2025</span></p>
                    <p class="text-sm text-slate-600">Total Amount: <span id="thank-you-order-total" class="font-medium text-indigo-600">$0.00</span></p>
                    <p class="text-sm text-slate-600">Payment Method: <span id="thank-you-payment-method" class="font-medium">Credit Card</span></p>
                </div>
                <div class="mt-10 space-y-3 sm:space-y-0 sm:flex sm:justify-center sm:space-x-4">
                    <a href="#products" data-page="products" class="btn btn-primary text-base w-full sm:w-auto">
                        <i class="fas fa-shopping-cart mr-2"></i>Continue Shopping
                    </a>
                    <a href="#home" data-page="home" class="btn btn-outline text-base w-full sm:w-auto">
                        <i class="fas fa-home mr-2"></i>Back to Home
                    </a>
                </div>
            </div>
        </section>

        <section id="book-detail-page" class="page-section">
            <div id="book-detail-loader" class="loader"></div>
            <div id="book-detail-content-area" class="bg-white p-6 md:p-10 rounded-xl shadow-xl opacity-0 transition-opacity duration-500">
                </div>
        </section>


        <section id="about" class="page-section bg-white p-8 md:p-12 rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-slate-800 mb-8 text-center">About ProShop</h1>
            <div class="max-w-3xl mx-auto text-lg text-slate-600 leading-relaxed space-y-6">
                <p>Welcome to ProShop, your number one source for all things awesome. We're dedicated to giving you the very best of products, with a focus on <strong class="text-indigo-600">quality, customer service, and uniqueness.</strong></p>
                <p>Founded in 2024 by a team of passionate individuals, ProShop has come a long way from its beginnings. When we first started out, our passion for eco-friendly and high-quality products drove us to do intense research, and gave us the impetus to turn hard work and inspiration into a booming online store.</p>
                <p>We now serve customers all over the world, and are thrilled to be a part of the fair-trade wing of the e-commerce industry. We hope you enjoy our products as much as we enjoy offering them to you. If you have any questions or comments, please don't hesitate to contact us.</p>
                <div class="text-center pt-6">
                    <a href="#contact" data-page="contact" class="btn btn-primary"><i class="fas fa-envelope mr-2"></i>Get In Touch</a>
                </div>
            </div>
        </section>

        <section id="contact" class="page-section bg-white p-8 md:p-12 rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-slate-800 mb-8 text-center">Contact Us</h1>
            <div class="max-w-2xl mx-auto">
                <p class="text-lg text-slate-600 leading-relaxed mb-8 text-center">
                    Have questions, feedback, or just want to say hello? We'd love to hear from you!
                </p>
                <form id="contact-form" class="space-y-6">
                    <div>
                        <label for="contact-name" class="form-label">Full Name <span class="text-red-500">*</span></label>
                        <input type="text" id="contact-name" name="contact-name" required class="form-input">
                    </div>
                    <div>
                        <label for="contact-email" class="form-label">Email Address <span class="text-red-500">*</span></label>
                        <input type="email" id="contact-email" name="contact-email" required class="form-input">
                    </div>
                    <div>
                        <label for="contact-subject" class="form-label">Subject <span class="text-red-500">*</span></label>
                        <input type="text" id="contact-subject" name="contact-subject" required class="form-input">
                    </div>
                    <div>
                        <label for="contact-message" class="form-label">Message <span class="text-red-500">*</span></label>
                        <textarea id="contact-message" name="contact-message" rows="5" required class="form-input"></textarea>
                    </div>
                    <div class="text-center">
                        <button type="submit" id="send-message-btn" class="btn btn-primary text-base px-8">
                           <span class="send-message-text"><i class="fas fa-paper-plane mr-2"></i>Send Message</span>
                           <span class="send-message-loader hidden"><i class="fas fa-spinner fa-spin mr-2"></i>Sending...</span>
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <section id="account" class="page-section bg-white p-8 md:p-12 rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-slate-800 mb-10">My Account</h1>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="md:col-span-1">
                    <ul class="space-y-1">
                        <li><a href="#order-history" class="account-nav-link active" data-account-tab="order-history">Order History</a></li>
                        <li><a href="#profile-settings" class="account-nav-link" data-account-tab="profile-settings">Profile Settings</a></li>
                        <li><a href="#saved-addresses" class="account-nav-link" data-account-tab="saved-addresses">Saved Addresses</a></li>
                        <li><a href="#my-wishlist" class="account-nav-link" data-account-tab="my-wishlist">My Wishlist (<span id="account-wishlist-count">0</span>)</a></li>
                        <li><a href="#logout" class="account-nav-link text-red-600 hover:bg-red-50 hover:text-red-700" id="logout-btn">Logout</a></li>
                    </ul>
                </div>
                <div class="md:col-span-3">
                    <div id="account-content-order-history" class="account-tab-content">
                        <h2 class="text-2xl font-semibold text-slate-700 mb-6">Recent Orders</h2>
                        <div class="border rounded-lg p-6 text-center text-slate-500">
                            <i class="fas fa-box-open text-4xl mb-3 text-slate-400"></i>
                            <p>You have no recent orders. Time to <a href="#products" data-page="products" class="text-indigo-600 hover:underline">shop</a>!</p>
                        </div>
                        </div>
                    <div id="account-content-profile-settings" class="account-tab-content hidden">
                        <h2 class="text-2xl font-semibold text-slate-700 mb-6">Profile Settings</h2>
                        <form class="space-y-4">
                             <div><label class="form-label">Name</label><input type="text" class="form-input" value="John Doe (Placeholder)"></div>
                             <div><label class="form-label">Email</label><input type="email" class="form-input" value="john.doe@example.com (Placeholder)" readonly></div>
                             <button type="submit" class="btn btn-primary">Save Changes</button>
                        </form>
                    </div>
                    <div id="account-content-saved-addresses" class="account-tab-content hidden">
                        <h2 class="text-2xl font-semibold text-slate-700 mb-6">Saved Addresses</h2>
                         <p class="text-slate-500">No saved addresses yet.</p>
                    </div>
                    <div id="account-content-my-wishlist" class="account-tab-content hidden">
                        <h2 class="text-2xl font-semibold text-slate-700 mb-6">My Wishlist</h2>
                        <div id="account-wishlist-items" class="space-y-4">
                            <p class="text-slate-500">Your wishlist is empty.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-slate-800 text-slate-300 py-16 mt-16">
        <div class="container mx-auto px-4 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10 mb-10">
                <div>
                    <h3 class="text-2xl font-bold text-white mb-4 flex items-center"><i class="fas fa-shopping-bag mr-2"></i>ProShop</h3>
                    <p class="text-sm leading-relaxed">Premium products, exceptional service. Your satisfaction is our priority.</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4">Shop</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#products" data-page="products" class="hover:text-indigo-400 transition-colors">All Products</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">New Arrivals</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">Best Sellers</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">Sales & Deals</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4">Customer Service</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#contact" data-page="contact" class="hover:text-indigo-400 transition-colors">Contact Us</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">FAQs</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">Shipping Information</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">Returns & Exchanges</a></li>
                        <li><a href="#" class="hover:text-indigo-400 transition-colors">Track Your Order</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4">Stay Connected</h3>
                    <p class="text-sm mb-3">Subscribe to our newsletter for updates and special offers.</p>
                    <form class="flex" id="newsletter-form">
                        <input type="email" id="newsletter-email" placeholder="Your email" required class="form-input py-2 text-slate-800 rounded-r-none flex-grow focus:ring-0">
                        <button type="submit" class="btn btn-primary rounded-l-none px-4"><i class="fas fa-paper-plane"></i></button>
                    </form>
                    <div class="flex space-x-4 mt-6">
                        <a href="#" class="text-slate-400 hover:text-indigo-400 transition-colors" aria-label="Facebook"><i class="fab fa-facebook-f text-xl"></i></a>
                        <a href="#" class="text-slate-400 hover:text-indigo-400 transition-colors" aria-label="Twitter"><i class="fab fa-twitter text-xl"></i></a>
                        <a href="#" class="text-slate-400 hover:text-indigo-400 transition-colors" aria-label="Instagram"><i class="fab fa-instagram text-xl"></i></a>
                        <a href="#" class="text-slate-400 hover:text-indigo-400 transition-colors" aria-label="Pinterest"><i class="fab fa-pinterest-p text-xl"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-700 pt-8 text-center text-sm">
                &copy; <span id="current-year"></span> ProShop. All Rights Reserved. Designed with <i class="fas fa-heart text-red-500 transition-transform duration-200 hover:scale-125"></i> by AI.
            </div>
        </div>
    </footer>

    <div id="product-modal" class="modal hidden" aria-labelledby="product-modal-title" aria-modal="true" role="dialog">
        <div class="modal-content w-11/12 md:max-w-3xl lg:max-w-4xl">
            <div id="product-modal-content" class="relative">
                 <div class="loader"></div> </div>
        </div>
    </div>

    <div id="toast-notification" role="alert" aria-live="assertive">
        <p id="toast-message">Item action!</p>
    </div>
    
    <button id="scroll-to-top" class="fixed bottom-6 right-6 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 opacity-0 pointer-events-none transform translate-y-4" aria-label="Scroll to top">
        <i class="fas fa-arrow-up"></i>
    </button>


    <script>
        // --- Sample Product Data (Enhanced) ---
        // (JavaScript code remains the same as previously provided)
        // ... (All the JavaScript from the previous response goes here) ...
        // The sampleProducts array, PROMO_CODES, currentProducts, DEBOUNCE_DELAY,
        // and the entire 'DOMContentLoaded' event listener with all its functions.

        // --- Sample Product Data (Enhanced) ---
        const sampleProducts = [
            { id: 1, name: "Zenith Wireless Headphones", price: 129.99, image: "https://placehold.co/600x400/818CF8/FFFFFF?text=Zenith+Headphones", images: ["https://placehold.co/800x600/818CF8/FFFFFF?text=Zenith+1", "https://placehold.co/800x600/A5B4FC/374151?text=Zenith+2", "https://placehold.co/800x600/C7D2FE/374151?text=Zenith+3", "https://placehold.co/800x600/6366F1/FFFFFF?text=Zenith+4"], description: "Immersive sound quality with active noise cancellation and 24-hour battery life. Perfect for audiophiles on the go. Enjoy crystal clear highs and deep, rich bass with these premium over-ear headphones. Features intuitive touch controls and a comfortable, lightweight design for extended listening sessions.", category: "Electronics", stock: 15, rating: 4.5, tags: ["audio", "bluetooth", "noise cancelling", "premium", "headphones"] },
            { id: 2, name: "Eco Threads Organic Tee", price: 34.99, image: "https://placehold.co/600x400/F472B6/FFFFFF?text=Eco+Tee", images: ["https://placehold.co/800x600/F472B6/FFFFFF?text=Tee+Front", "https://placehold.co/800x600/F9A8D4/374151?text=Tee+Back", "https://placehold.co/800x600/FBCFE8/374151?text=Tee+Fabric"], description: "Sustainably sourced 100% organic cotton t-shirt. Soft, breathable, and kind to the planet. Ethically produced and designed for a classic, comfortable fit. Available in multiple earth-toned colors.", category: "Apparel", stock: 30, rating: 4.8, tags: ["clothing", "sustainable", "cotton", "basic", "organic", "eco-friendly"] },
            { id: 3, name: "Nordic Minimalist Coffee Table", price: 249.00, image: "https://placehold.co/600x400/34D399/FFFFFF?text=Nordic+Table", images: ["https://placehold.co/800x600/34D399/FFFFFF?text=Table+Top", "https://placehold.co/800x600/6EE7B7/374151?text=Table+Side", "https://placehold.co/800x600/A7F3D0/374151?text=Table+Detail"], description: "Solid oak wood coffee table with a sleek, minimalist design. Adds a touch of Scandinavian elegance to any living space. Features durable construction and a natural, smooth finish. Easy to assemble.", category: "Home Goods", stock: 8, rating: 4.2, tags: ["furniture", "living room", "wood", "modern", "scandinavian"] },
            { id: 4, name: "The Quantum Enigma", price: 22.50, image: "https://placehold.co/600x800/FBBF24/FFFFFF?text=Quantum+Enigma", images: ["https://placehold.co/600x800/FBBF24/FFFFFF?text=Book+Cover+Tall", "https://placehold.co/800x600/FCD34D/374151?text=Book+Spread", "https://placehold.co/800x600/FDBA74/374151?text=Author+Photo+Placeholder"], description: "A mind-bending journey into the mysteries of quantum physics, exploring its philosophical implications and the nature of reality itself. This accessible guide makes complex concepts understandable for everyone. Written by a leading physicist, it's a must-read for the curious mind.", category: "Books", stock: 50, rating: 4.7, tags: ["science", "physics", "non-fiction", "educational", "philosophy", "best-seller"], author: "Dr. Evelyn Reed", isbn: "978-0-123456-78-9", pages: 320, publisher: "Knowledge Press", publishedDate: "2023-05-15", reviews: [ { reviewer: "Alex P.", rating: 5, comment: "Absolutely fascinating! Made me question everything I thought I knew. Dr. Reed explains complex topics with such clarity." }, { reviewer: "Bookworm_88", rating: 4, comment: "A bit dense in places, but ultimately very rewarding. Highly recommend for curious minds. The diagrams are helpful." }, { reviewer: "ScienceGeek", rating: 4.5, comment: "Well-researched and engaging. One of the best popular science books I've read this year. Truly eye-opening!"}, { reviewer: "CuriousReader", rating: 5, comment: "Couldn't put it down! The philosophical discussions were particularly thought-provoking."} ] },
            { id: 5, name: "Aura Smart Fitness Watch", price: 199.99, image: "https://placehold.co/600x400/EC4899/FFFFFF?text=Aura+Watch", images: ["https://placehold.co/800x600/EC4899/FFFFFF?text=Watch+Face", "https://placehold.co/800x600/F9A8D4/374151?text=Watch+Strap", "https://placehold.co/800x600/FBCFE8/374151?text=Watch+Display"], description: "Track your fitness goals, monitor health vitals (heart rate, SpO2), and stay connected with this sleek smartwatch. Features GPS, multiple sport modes, and a vibrant AMOLED display. Long-lasting battery and water-resistant.", category: "Electronics", stock: 22, rating: 4.6, tags: ["wearable", "health", "fitness tracker", "smartwatch", "gps", "amoled"] },
            { id: 6, name: "Artisan Leather Messenger Bag", price: 175.00, image: "https://placehold.co/600x400/A78BFA/FFFFFF?text=Messenger+Bag", images: ["https://placehold.co/800x600/A78BFA/FFFFFF?text=Bag+Open", "https://placehold.co/800x600/C4B5FD/374151?text=Bag+Detail", "https://placehold.co/800x600/DDD6FE/374151?text=Bag+Lifestyle"], description: "Handcrafted full-grain leather messenger bag. Stylish and durable for everyday use or travel. Features multiple compartments, a padded laptop sleeve, and an adjustable shoulder strap. Ages beautifully over time.", category: "Apparel", stock: 0, rating: 4.9, tags: ["bag", "accessories", "leather", "handmade", "vintage"] },
            { id: 7, name: "Gourmet Coffee Bean Sampler", price: 49.99, image: "https://placehold.co/600x400/F59E0B/FFFFFF?text=Coffee+Sampler", images: ["https://placehold.co/800x600/F59E0B/FFFFFF?text=Coffee+Beans", "https://placehold.co/800x600/FCD34D/374151?text=Coffee+Packaging"], description: "Explore a world of flavor with this curated selection of four premium, ethically sourced single-origin coffee beans. Whole beans, freshly roasted for optimal aroma and taste. Includes tasting notes for each variety.", category: "Home Goods", stock: 40, rating: 4.7, tags: ["food", "beverage", "gourmet", "gift", "coffee", "artisan"] },
            { id: 8, name: "Yoga Essentials Mat & Block Set", price: 65.00, image: "https://placehold.co/600x400/22D3EE/FFFFFF?text=Yoga+Set", images: ["https://placehold.co/800x600/22D3EE/FFFFFF?text=Yoga+Mat", "https://placehold.co/800x600/67E8F9/374151?text=Yoga+Block", "https://placehold.co/800x600/A5F3FC/374151?text=Yoga+Set+InUse"], description: "High-quality, non-slip TPE yoga mat and supportive EVA foam block. Perfect for all levels of practice, from beginner to advanced. Mat includes a carrying strap. Eco-friendly materials.", category: "Sports", stock: 18, rating: 4.3, tags: ["fitness", "wellness", "exercise", "yoga equipment", "eco-friendly"] },
            { id: 9, name: "Pro Gaming Mouse X5000", price: 79.99, image: "https://placehold.co/600x400/EF4444/FFFFFF?text=Gaming+Mouse", images: ["https://placehold.co/800x600/EF4444/FFFFFF?text=Mouse+Top", "https://placehold.co/800x600/F87171/374151?text=Mouse+Side"], description: "Dominate your games with this ergonomic gaming mouse featuring customizable RGB lighting, programmable buttons, and an ultra-precise optical sensor (up to 16000 DPI).", category: "Electronics", stock: 25, rating: 4.8, tags: ["gaming", "pc accessories", "esports", "rgb"] },
            { id: 10, name: "Traveler's Weatherproof Backpack", price: 110.50, image: "https://placehold.co/600x400/10B981/FFFFFF?text=Backpack", images: ["https://placehold.co/800x600/10B981/FFFFFF?text=Backpack+Front", "https://placehold.co/800x600/34D399/374151?text=Backpack+Open"], description: "Durable and weatherproof backpack designed for adventurers. Multiple compartments, laptop sleeve, and comfortable ergonomic straps. Ideal for hiking, commuting, or travel.", category: "Apparel", stock: 12, rating: 4.6, tags: ["travel", "outdoors", "bag", "waterproof"] }
        ];
        
        const PROMO_CODES = {
            "SAVE10": { type: "percentage", value: 10 }, // 10% off
            "PROSHOP20": { type: "fixed", value: 20 } // $20 off
        };
        let appliedPromoCode = null;


        let currentProducts = [...sampleProducts]; // For filtering/sorting
        const DEBOUNCE_DELAY = 300; // ms for search input

        document.addEventListener('DOMContentLoaded', () => {
            // --- Element Selectors (Grouped for better readability) ---
            const Elements = {
                header: document.querySelector('header'),
                mobileMenuButton: document.getElementById('mobile-menu-button'),
                mobileMenu: document.getElementById('mobile-menu'),
                pageSections: document.querySelectorAll('.page-section'),
                navLinks: document.querySelectorAll('.nav-link, #logo, [data-page]'),
                
                // Home Page
                featuredProductsGrid: document.getElementById('featured-products-grid'),
                featuredLoader: document.getElementById('featured-loader'),

                // Products Page
                allProductsGrid: document.getElementById('all-products-grid'),
                productsLoader: document.getElementById('products-loader'),
                noProductsMessage: document.getElementById('no-products-message'),
                categoryFilter: document.getElementById('category-filter'),
                sortFilter: document.getElementById('sort-filter'),
                mainSearchInput: document.getElementById('main-search-input'),
                desktopSearchInput: document.getElementById('desktop-search-input'),
                mobileSearchInput: document.getElementById('mobile-search-input'),
                clearFiltersBtn: document.getElementById('clear-filters-btn'),

                // Cart Page
                cartItemsContainer: document.getElementById('cart-items-container'),
                cartItemCountEl: document.getElementById('cart-item-count'),
                cartEmptyMessage: document.getElementById('cart-empty-message'),
                cartSummaryContainer: document.getElementById('cart-summary-container'),
                cartSummaryEl: document.getElementById('cart-summary'),
                cartSubtotalEl: document.getElementById('cart-subtotal'),
                cartTotalEl: document.getElementById('cart-total'),
                cartSummaryItemCountEl: document.getElementById('cart-summary-item-count'),
                promoCodeInput: document.getElementById('promo-code'),
                applyPromoBtn: document.getElementById('apply-promo-btn'),
                promoFeedbackEl: document.getElementById('promo-feedback'),
                discountAppliedRow: document.getElementById('discount-applied-row'),
                cartDiscountAmountEl: document.getElementById('cart-discount-amount'),
                discountCodeAppliedEl: document.getElementById('discount-code-applied'),
                proceedCheckoutBtn: document.getElementById('proceed-checkout-btn'),


                // Product Modal
                productModal: document.getElementById('product-modal'),
                productModalContent: document.getElementById('product-modal-content'),

                // Toast
                toastNotification: document.getElementById('toast-notification'),
                toastMessage: document.getElementById('toast-message'),

                // Checkout Page
                shippingForm: document.getElementById('shipping-form'),
                checkoutOrderSummary: document.getElementById('checkout-order-summary'),
                checkoutSubtotalEl: document.getElementById('checkout-subtotal'),
                checkoutTotalEl: document.getElementById('checkout-total'),
                checkoutDiscountRow: document.getElementById('checkout-discount-row'),
                checkoutDiscountAmountEl: document.getElementById('checkout-discount-amount'),
                placeOrderBtn: document.getElementById('place-order-btn'),
                paymentRadios: document.querySelectorAll('input[name="payment"]'),
                cardDetailsForm: document.getElementById('card-details-form'),


                // Thank You Page
                thankYouCardContent: document.getElementById('thank-you-card-content'),
                thankYouCheck: document.getElementById('thank-you-check'),
                thankYouEmailEl: document.getElementById('thank-you-email'),
                thankYouOrderIdEl: document.getElementById('thank-you-order-id'),
                thankYouOrderDateEl: document.getElementById('thank-you-order-date'),
                thankYouOrderTotalEl: document.getElementById('thank-you-order-total'),
                thankYouPaymentMethodEl: document.getElementById('thank-you-payment-method'),
                confettiContainer: document.getElementById('confetti-container'),

                // Book Detail Page
                bookDetailContentArea: document.getElementById('book-detail-content-area'),
                bookDetailLoader: document.getElementById('book-detail-loader'),

                // Account Page
                accountNavLinks: document.querySelectorAll('.account-nav-link'),
                accountTabContents: document.querySelectorAll('.account-tab-content'),
                accountWishlistCount: document.getElementById('account-wishlist-count'),
                accountWishlistItems: document.getElementById('account-wishlist-items'),
                logoutBtn: document.getElementById('logout-btn'),

                // Footer & Misc
                newsletterForm: document.getElementById('newsletter-form'),
                scrollToTopBtn: document.getElementById('scroll-to-top'),
                currentYearEl: document.getElementById('current-year'),
            };

            // --- State ---
            let cart = JSON.parse(localStorage.getItem('proShopCartV4')) || [];
            let wishlist = JSON.parse(localStorage.getItem('proShopWishlistV4')) || [];
            let searchDebounceTimer;

            // --- Utility Functions ---
            const formatPrice = (price) => `$${price.toFixed(2)}`;

            function showLoader(loaderElement) {
                if (loaderElement) loaderElement.classList.remove('hidden');
            }
            function hideLoader(loaderElement) {
                if (loaderElement) loaderElement.classList.add('hidden');
            }
            
            function animateElement(element, animationClass, removeAfter = true, duration = 500) {
                if (!element) return;
                element.classList.add(animationClass);
                if (removeAfter) {
                    setTimeout(() => element.classList.remove(animationClass), duration);
                }
            }

            // --- Navigation ---
            function navigateToPage(pageId, params = null, skipHistory = false) {
                Elements.pageSections.forEach(section => {
                    section.classList.remove('active');
                });
                
                const targetSection = document.getElementById(pageId);
                if (targetSection) {
                     setTimeout(() => targetSection.classList.add('active'), 10); // Slight delay for transition
                }


                Elements.navLinks.forEach(link => {
                    link.classList.remove('nav-link-active');
                    if (link.dataset.page === pageId || (link.id === 'logo' && pageId === 'home')) {
                        link.classList.add('nav-link-active');
                    }
                });

                if (!Elements.mobileMenu.classList.contains('hidden')) {
                    Elements.mobileMenu.classList.add('hidden');
                    Elements.mobileMenuButton.setAttribute('aria-expanded', 'false');
                }
                
                if (!skipHistory && window.location.hash !== `#${pageId}`) {
                     window.location.hash = pageId; // Update hash for direct link, unless it's a sub-action like book detail from hash
                }
                 window.scrollTo({ top: 0, behavior: 'smooth' });


                // Page specific initializations
                if (pageId === 'products') {
                    applyFiltersAndSort();
                } else if (pageId === 'book-detail-page' && params && params.productId) {
                    renderBookDetailPage(params.productId);
                } else if (pageId === 'home') {
                    loadFeaturedProducts();
                } else if (pageId === 'account') {
                    updateAccountWishlistDisplay();
                    Elements.accountWishlistCount.textContent = wishlist.length;
                } else if (pageId === 'thank-you' && Elements.thankYouCardContent) {
                    Elements.thankYouCardContent.style.opacity = '0';
                    Elements.thankYouCardContent.style.transform = 'scale(0.95)';
                    Elements.thankYouCheck.style.transform = 'scale(0)';
                     setTimeout(() => {
                        Elements.thankYouCardContent.style.opacity = '1';
                        Elements.thankYouCardContent.style.transform = 'scale(1)';
                        Elements.thankYouCheck.style.transform = 'scale(1)';
                        Elements.thankYouCheck.classList.add('transition-transform', 'duration-500', 'ease-out');
                        createConfetti();
                    }, 200);
                }

                 // Handle category links from product modal back to products page
                if (params && params.category && Elements.categoryFilter) { // Added Elements check
                    Elements.categoryFilter.value = params.category;
                }

            }

            Elements.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const pageId = link.dataset.page || (link.id === 'logo' ? 'home' : null);
                    if (pageId) {
                        e.preventDefault();
                        navigateToPage(pageId);
                    }
                });
            });
            
            // Initial page load from hash or default to home
            function handleHashChange() {
                const hash = window.location.hash.substring(1);
                let pageId = 'home';
                let params = null;

                if (hash.startsWith('book/')) {
                    const bookId = parseInt(hash.split('/')[1]);
                    if (bookId) {
                        pageId = 'book-detail-page';
                        params = { productId: bookId };
                    }
                } else if (hash) {
                    const sectionExists = Array.from(Elements.pageSections).some(s => s.id === hash);
                    if (sectionExists) pageId = hash;
                }
                navigateToPage(pageId, params, true); // skipHistory true as hash is already set or being set
            }

            window.addEventListener('hashchange', handleHashChange);
            

            if (Elements.mobileMenuButton) {
                Elements.mobileMenuButton.addEventListener('click', () => {
                    const isHidden = Elements.mobileMenu.classList.toggle('hidden');
                    Elements.mobileMenuButton.setAttribute('aria-expanded', String(!isHidden));
                });
            }

            // Scroll to top button
            if (Elements.scrollToTopBtn) {
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 300) {
                        Elements.scrollToTopBtn.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
                        Elements.scrollToTopBtn.classList.add('opacity-100');
                    } else {
                        Elements.scrollToTopBtn.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
                        Elements.scrollToTopBtn.classList.remove('opacity-100');
                    }
                });
                Elements.scrollToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
            
            // --- Product Display & Filtering/Sorting ---
            function renderStarRating(rating, includeText = true) {
                let stars = '';
                const fullStars = Math.floor(rating);
                const halfStar = rating % 1 >= 0.4 && rating % 1 < 0.9; // Adjusted half-star logic
                const almostFullStar = rating % 1 >= 0.9; // If very close to full, render as full
                let actualFullStars = fullStars;
                if(almostFullStar) actualFullStars +=1;

                for (let i = 0; i < actualFullStars; i++) stars += '<i class="fas fa-star"></i>';
                if (halfStar && !almostFullStar) stars += '<i class="fas fa-star-half-alt"></i>';
                const emptyStars = 5 - actualFullStars - (halfStar && !almostFullStar ? 1 : 0);
                for (let i = 0; i < emptyStars; i++) stars += '<i class="far fa-star text-slate-300"></i>';
                
                const ratingText = includeText ? `<span class="ml-1.5 text-slate-500 text-xs font-medium">(${rating.toFixed(1)})</span>` : '';
                return `<div class="star-rating flex items-center text-sm text-amber-500" title="Rating: ${rating.toFixed(1)} out of 5">${stars} ${ratingText}</div>`;
            }

            function createProductCard(product) {
                const card = document.createElement('div');
                card.className = 'product-card group product-card-animated'; // Ensure animated class is present
                const isInWishlist = wishlist.includes(product.id);

                let specialButton = '';
                if (product.category === "Books") { // Check by category for books
                    specialButton = `<button class="btn btn-success text-xs px-3 py-2 view-book-page-btn w-full mt-2 flex items-center justify-center" data-product-id="${product.id}"><i class="fas fa-book-open mr-1.5"></i>View Details</button>`;
                }

                card.innerHTML = `
                    <div class="product-image-container">
                        <img src="${product.image}" alt="${product.name}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/600x400/E2E8F0/94A3B8?text=Not+Found';">
                    </div>
                    <div class="p-4 flex flex-col flex-grow"> <h3 class="text-md font-semibold text-slate-800 mb-1 truncate group-hover:text-indigo-600 transition-colors" title="${product.name}">${product.name}</h3>
                        <p class="text-xs text-slate-500 mb-2">${product.category}</p>
                        ${renderStarRating(product.rating)}
                        <div class="mt-2 mb-3 flex-grow"> <p class="text-xl font-bold text-indigo-700">${formatPrice(product.price)}</p>
                             ${product.stock === 0 ? '<p class="text-xs text-red-600 font-semibold mt-1">Out of Stock</p>' : product.stock < 10 ? `<p class="text-xs text-amber-600 font-semibold mt-1">Only ${product.stock} left!</p>` : '<p class="text-xs text-green-600 font-semibold mt-1">In Stock</p>'}
                        </div>
                        <div class="space-y-2 mt-auto pt-2 border-t border-slate-100"> <div class="flex items-center justify-between space-x-2">
                               <button class="btn btn-outline text-xs px-2.5 py-1.5 view-details-btn flex-grow ${product.category === "Books" ? 'hidden' : ''}" data-product-id="${product.id}" aria-label="View details for ${product.name}"><i class="fas fa-eye mr-1"></i>Details</button>
                               <button class="btn btn-primary text-xs px-2.5 py-1.5 add-to-cart-btn flex-grow ${product.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}" data-product-id="${product.id}" ${product.stock === 0 ? 'disabled' : ''} aria-label="Add ${product.name} to cart">
                                    <i class="fas fa-cart-plus mr-1"></i>Cart
                               </button>
                               <button class="wishlist-btn p-2 rounded-md text-slate-400 hover:text-red-500 ${isInWishlist ? 'active' : ''} transition-colors duration-200" data-product-id="${product.id}" title="${isInWishlist ? 'Remove from Wishlist' : 'Add to Wishlist'}" aria-pressed="${isInWishlist}">
                                    <i class="fas fa-heart text-lg"></i> </button>
                            </div>
                            ${specialButton}
                        </div>
                    </div>
                `;
                card.querySelector('.add-to-cart-btn').addEventListener('click', (e) => { e.stopPropagation(); addToCart(product.id); });
                const viewDetailsBtn = card.querySelector('.view-details-btn');
                if (viewDetailsBtn) {
                    viewDetailsBtn.addEventListener('click', (e) => { e.stopPropagation(); showProductDetailModal(product.id); });
                }
                const viewBookPageBtn = card.querySelector('.view-book-page-btn');
                if (viewBookPageBtn) {
                    viewBookPageBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        navigateToPage('book-detail-page', { productId: product.id });
                        // window.location.hash = `book/${product.id}`; // Handled by navigateToPage
                    });
                }
                card.querySelector('.wishlist-btn').addEventListener('click', (e) => { e.stopPropagation(); toggleWishlist(product.id, e.currentTarget); });
                return card;
            }
            
            function createSkeletonCard() {
                const card = document.createElement('div');
                card.className = 'skeleton-card';
                card.innerHTML = `
                    <div class="skeleton-image"></div>
                    <div class="skeleton-line w-3/4"></div>
                    <div class="skeleton-line w-1/2"></div>
                    <div class="skeleton-line w-1/3 mt-auto"></div>
                `;
                return card;
            }

            function displayProducts(productsToDisplay, container, showSkeletons = false) {
                container.innerHTML = ''; // Clear previous content

                if (showSkeletons) {
                    for (let i = 0; i < 8; i++) { // Display e.g., 8 skeletons
                        container.appendChild(createSkeletonCard());
                    }
                    if (Elements.noProductsMessage) Elements.noProductsMessage.classList.add('hidden');
                    if (container) container.classList.remove('hidden');
                    return;
                }


                if (productsToDisplay.length === 0) {
                    if (Elements.noProductsMessage) Elements.noProductsMessage.classList.remove('hidden');
                    if (container) container.classList.add('hidden');
                } else {
                    if (Elements.noProductsMessage) Elements.noProductsMessage.classList.add('hidden');
                    if (container) container.classList.remove('hidden');
                    productsToDisplay.forEach((product, index) => {
                        const card = createProductCard(product);
                        // Stagger animation
                        card.style.animationDelay = `${index * 0.07}s`;
                        // Intersection Observer for fade-in can be added here if needed for very long lists
                        container.appendChild(card);
                    });
                }
            }
            
            async function loadFeaturedProducts() {
                showLoader(Elements.featuredLoader);
                displayProducts([], Elements.featuredProductsGrid, true); // Show skeletons

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Get 4 random distinct products for featured
                const shuffled = [...sampleProducts].sort(() => 0.5 - Math.random());
                const featured = shuffled.slice(0, 4);

                displayProducts(featured, Elements.featuredProductsGrid);
                hideLoader(Elements.featuredLoader);
                observeForAnimation(Elements.featuredProductsGrid.querySelectorAll('[data-animate-on-scroll]'));
            }


            async function applyFiltersAndSort() {
                if (!Elements.allProductsGrid) return;
                showLoader(Elements.productsLoader);
                displayProducts([], Elements.allProductsGrid, true); // Show skeletons

                // Simulate API delay for filtering
                await new Promise(resolve => setTimeout(resolve, 500));


                let filtered = [...sampleProducts];
                const category = Elements.categoryFilter ? Elements.categoryFilter.value : 'all';
                const sortValue = Elements.sortFilter ? Elements.sortFilter.value : 'default';
                const searchTerm = (Elements.mainSearchInput ? Elements.mainSearchInput.value : '').toLowerCase().trim();

                if (category !== 'all') {
                    filtered = filtered.filter(p => p.category === category);
                }
                if (searchTerm) {
                    filtered = filtered.filter(p =>
                        p.name.toLowerCase().includes(searchTerm) ||
                        p.description.toLowerCase().includes(searchTerm) ||
                        (p.tags && p.tags.some(tag => tag.toLowerCase().includes(searchTerm))) ||
                        (p.author && p.author.toLowerCase().includes(searchTerm))
                    );
                }
                switch (sortValue) {
                    case 'price-asc': filtered.sort((a, b) => a.price - b.price); break;
                    case 'price-desc': filtered.sort((a, b) => b.price - a.price); break;
                    case 'name-asc': filtered.sort((a, b) => a.name.localeCompare(b.name)); break;
                    case 'name-desc': filtered.sort((a, b) => b.name.localeCompare(a.name)); break;
                    case 'rating-desc': filtered.sort((a,b) => b.rating - a.rating); break;
                }
                currentProducts = filtered;
                displayProducts(currentProducts, Elements.allProductsGrid);
                hideLoader(Elements.productsLoader);
                observeForAnimation(Elements.allProductsGrid.querySelectorAll('.product-card-animated'));
            }

            if (Elements.categoryFilter) Elements.categoryFilter.addEventListener('change', applyFiltersAndSort);
            if (Elements.sortFilter) Elements.sortFilter.addEventListener('change', applyFiltersAndSort);
            if (Elements.clearFiltersBtn) {
                Elements.clearFiltersBtn.addEventListener('click', () => {
                    if(Elements.categoryFilter) Elements.categoryFilter.value = 'all';
                    if(Elements.sortFilter) Elements.sortFilter.value = 'default';
                    if(Elements.mainSearchInput) Elements.mainSearchInput.value = '';
                    if(Elements.desktopSearchInput) Elements.desktopSearchInput.value = '';
                    if(Elements.mobileSearchInput) Elements.mobileSearchInput.value = '';
                    applyFiltersAndSort();
                    showToast('Filters cleared!', 'info');
                });
            }

            function syncAndSearch(sourceElement) {
                const searchTerm = sourceElement.value;
                if (Elements.mainSearchInput && sourceElement !== Elements.mainSearchInput) Elements.mainSearchInput.value = searchTerm;
                if (Elements.desktopSearchInput && sourceElement !== Elements.desktopSearchInput) Elements.desktopSearchInput.value = searchTerm;
                if (Elements.mobileSearchInput && sourceElement !== Elements.mobileSearchInput) Elements.mobileSearchInput.value = searchTerm;
                
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => {
                    const currentPageId = document.querySelector('.page-section.active')?.id;
                    if (currentPageId !== 'products' && searchTerm.trim() !== '') {
                        navigateToPage('products');
                         setTimeout(applyFiltersAndSort, 150); // Ensure page context before filtering
                    } else {
                        applyFiltersAndSort();
                    }
                }, DEBOUNCE_DELAY);
            }

            if (Elements.mainSearchInput) Elements.mainSearchInput.addEventListener('input', () => syncAndSearch(Elements.mainSearchInput));
            if (Elements.desktopSearchInput) Elements.desktopSearchInput.addEventListener('input', () => syncAndSearch(Elements.desktopSearchInput));
            if (Elements.mobileSearchInput) Elements.mobileSearchInput.addEventListener('input', () => syncAndSearch(Elements.mobileSearchInput));


            // --- Product Detail Modal ---
             function showProductDetailModal(productId) {
                const product = sampleProducts.find(p => p.id === productId);
                if (!product) return;

                Elements.productModalContent.innerHTML = '<div class="loader"></div>'; // Show loader initially
                Elements.productModal.classList.remove('hidden');
                Elements.productModal.classList.add('open');
                document.body.classList.add('overflow-hidden'); // Prevent body scroll

                // Simulate loading delay for content
                setTimeout(() => {
                    let imageGalleryHTML = `<img src="${product.image}" alt="${product.name}" class="w-full h-auto max-h-[60vh] object-contain rounded-lg shadow-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/800x600/E2E8F0/94A3B8?text=Main+Image+Missing';">`;
                    if (product.images && product.images.length > 0) {
                        const mainImageSrc = product.images[0];
                        imageGalleryHTML = `
                            <div class="main-image-container mb-3 h-80 sm:h-96 bg-slate-100 rounded-lg overflow-hidden flex justify-center items-center">
                                <img id="modal-main-image" src="${mainImageSrc}" alt="${product.name}" class="w-auto h-full max-w-full object-contain transition-opacity duration-300" onerror="this.onerror=null;this.src='https://placehold.co/800x600/E2E8F0/94A3B8?text=Image+Missing';">
                            </div>
                            <div class="thumbnail-gallery flex space-x-2 overflow-x-auto p-1 scrollbar-thin scrollbar-thumb-slate-300 scrollbar-track-slate-100">
                                ${product.images.map((imgSrc, index) => `
                                    <img src="${imgSrc}" alt="Thumbnail ${index + 1} for ${product.name}" class="h-20 w-20 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-indigo-500 transition-all duration-200 ${index === 0 ? 'border-indigo-500 ring-2 ring-indigo-300' : ''}" data-img-src="${imgSrc}" onerror="this.style.display='none';">
                                `).join('')}
                            </div>
                        `;
                    }

                    Elements.productModalContent.innerHTML = `
                        <button id="close-modal-button-inner" class="absolute top-3 right-4 text-slate-500 hover:text-slate-800 text-3xl z-20 transition-transform hover:scale-110" aria-label="Close product details">&times;</button>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-start">
                            <div class="md:sticky md:top-6">
                                ${imageGalleryHTML}
                            </div>
                            <div class="pt-1">
                                <h2 id="product-modal-title" class="text-2xl lg:text-3xl font-extrabold text-slate-800 mb-2">${product.name}</h2>
                                <p class="text-slate-500 text-sm mb-2">Category: <a href="#products" data-page="products" data-category-modal="${product.category}" class="text-indigo-600 hover:underline">${product.category}</a></p>
                                <div class="mb-3">${renderStarRating(product.rating)}</div>
                                <p class="text-3xl font-bold text-indigo-700 mb-4">${formatPrice(product.price)}</p>
                                <p class="text-slate-600 mb-4 leading-relaxed text-sm">${product.description}</p>
                                <p class="text-sm text-slate-600 mb-4">
                                    Stock: <span class="${product.stock > 0 ? 'text-green-600' : 'text-red-600'} font-semibold">
                                        ${product.stock > 0 ? `${product.stock} units available` : 'Currently Out of Stock'}
                                    </span>
                                </p>
                                <div class="flex items-center space-x-2 mb-5 quantity-control">
                                    <label for="quantity-modal-${product.id}" class="text-sm font-medium text-slate-700 sr-only">Quantity:</label>
                                    <button class="quantity-decrease" data-target="quantity-modal-${product.id}" aria-label="Decrease quantity"><i class="fas fa-minus"></i></button>
                                    <input type="number" id="quantity-modal-${product.id}" value="1" min="1" max="${product.stock > 0 ? product.stock : 1}" class="w-16 p-2 border border-slate-300 rounded-lg text-center form-input text-sm" ${product.stock === 0 ? 'disabled' : ''}>
                                    <button class="quantity-increase" data-target="quantity-modal-${product.id}" aria-label="Increase quantity"><i class="fas fa-plus"></i></button>
                                </div>
                                <button class="btn btn-primary w-full text-base add-to-cart-btn-modal ${product.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}" data-product-id="${product.id}" ${product.stock === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-cart-plus mr-2"></i> Add to Cart
                                </button>
                            </div>
                        </div>
                    `;
                
                    document.getElementById('close-modal-button-inner').addEventListener('click', closeProductModal);
                    Elements.productModalContent.querySelector('.add-to-cart-btn-modal').addEventListener('click', () => {
                        const quantityInput = document.getElementById(`quantity-modal-${product.id}`);
                        const quantity = parseInt(quantityInput.value);
                        addToCart(product.id, quantity);
                        animateElement(Elements.productModalContent.querySelector('.add-to-cart-btn-modal'), 'animate-pulseShort', true, 300); // Corrected class name
                    });

                    const thumbnails = Elements.productModalContent.querySelectorAll('.thumbnail-gallery img');
                    const mainModalImage = document.getElementById('modal-main-image');
                    thumbnails.forEach(thumb => {
                        thumb.addEventListener('click', () => {
                            if(mainModalImage) {
                                mainModalImage.style.opacity = '0';
                                setTimeout(() => {
                                    mainModalImage.src = thumb.dataset.imgSrc;
                                    mainModalImage.style.opacity = '1';
                                }, 150); // Match CSS transition
                            }
                            thumbnails.forEach(t => t.classList.remove('border-indigo-500', 'ring-2', 'ring-indigo-300'));
                            thumb.classList.add('border-indigo-500', 'ring-2', 'ring-indigo-300');
                        });
                    });
                    
                    const categoryLinkInModal = Elements.productModalContent.querySelector('[data-category-modal]');
                    if(categoryLinkInModal) {
                        categoryLinkInModal.addEventListener('click', (e) => {
                            e.preventDefault();
                            const cat = e.currentTarget.dataset.categoryModal;
                            closeProductModal();
                            navigateToPage('products', { category: cat }); // Pass category to pre-select
                        });
                    }
                    setupQuantityControls(Elements.productModalContent);
                }, 300); // Simulate load time
            }

            function closeProductModal() {
                Elements.productModal.classList.remove('open');
                document.body.classList.remove('overflow-hidden'); // Re-enable body scroll
                setTimeout(() => {
                    Elements.productModal.classList.add('hidden');
                    Elements.productModalContent.innerHTML = ''; // Clear content after transition
                }, 300); // Match CSS transition duration
            }

            if (Elements.productModal) {
                 Elements.productModal.addEventListener('click', (event) => { if (event.target === Elements.productModal) closeProductModal(); });
            }
            document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && Elements.productModal && Elements.productModal.classList.contains('open')) closeProductModal(); });

            // --- Dedicated Book Detail Page ---
            async function renderBookDetailPage(productId) {
                showLoader(Elements.bookDetailLoader);
                Elements.bookDetailContentArea.classList.remove('opacity-100');
                Elements.bookDetailContentArea.classList.add('opacity-0');

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 600));

                const product = sampleProducts.find(p => p.id === productId && p.category === "Books");
                hideLoader(Elements.bookDetailLoader);

                if (!product) {
                    Elements.bookDetailContentArea.innerHTML = '<p class="text-center text-red-500 py-10">Book not found or this is not a book product.</p>';
                    Elements.bookDetailContentArea.classList.add('opacity-100');
                    return;
                }

                let reviewsHTML = '<p class="text-slate-500">No reviews yet.</p>';
                if (product.reviews && product.reviews.length > 0) {
                    reviewsHTML = product.reviews.map(review => `
                        <div class="review-card mb-4 opacity-0" data-animate-on-scroll>
                            <div class="flex justify-between items-center mb-1.5">
                                <h4 class="font-semibold text-slate-700">${review.reviewer}</h4>
                                ${renderStarRating(review.rating, false)}
                            </div>
                            <p class="text-sm text-slate-600">${review.comment}</p>
                        </div>
                    `).join('');
                }

                Elements.bookDetailContentArea.innerHTML = `
                    <button data-page="products" class="btn btn-secondary mb-8 text-sm"><i class="fas fa-arrow-left mr-2"></i>Back to Products</button>
                    <div class="grid grid-cols-1 md:grid-cols-7 gap-8 lg:gap-12">
                        <div class="md:col-span-2 book-cover-container">
                            <img src="${product.images && product.images.length > 0 ? product.images[0] : product.image}" alt="Cover of ${product.name}" class="book-cover-image" onerror="this.onerror=null;this.src='https://placehold.co/600x800/E2E8F0/94A3B8?text=Cover+Missing';">
                        </div>
                        <div class="md:col-span-5">
                            <h1 class="text-3xl lg:text-4xl font-extrabold text-slate-800 mb-1">${product.name}</h1>
                            <p class="text-md text-slate-500 mb-2">By <span class="font-medium text-indigo-600">${product.author || 'N/A'}</span></p>
                            <div class="mb-4">${renderStarRating(product.rating)}</div>
                            <p class="text-3xl font-bold text-indigo-700 mb-5">${formatPrice(product.price)}</p>
                            
                            <div class="mb-5">
                                <h3 class="detail-section-title">Description</h3>
                                <p class="text-slate-600 leading-relaxed prose prose-sm max-w-none">${product.description}</p>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm text-slate-600 mb-5 bg-slate-50 p-4 rounded-lg">
                                <p><strong>ISBN:</strong> ${product.isbn || 'N/A'}</p>
                                <p><strong>Pages:</strong> ${product.pages || 'N/A'}</p>
                                <p><strong>Publisher:</strong> ${product.publisher || 'N/A'}</p>
                                <p><strong>Published:</strong> ${product.publishedDate || 'N/A'}</p>
                            </div>
                             <p class="text-sm text-slate-600 mb-5">
                                Stock: <span class="${product.stock > 0 ? 'text-green-600' : 'text-red-600'} font-semibold">
                                    ${product.stock > 0 ? `${product.stock} units available` : 'Currently Out of Stock'}
                                </span>
                            </p>
                            <div class="flex items-center space-x-2 mb-6 quantity-control">
                                <label for="quantity-book-${product.id}" class="text-sm font-medium text-slate-700 sr-only">Quantity:</label>
                                <button class="quantity-decrease" data-target="quantity-book-${product.id}" aria-label="Decrease quantity"><i class="fas fa-minus"></i></button>
                                <input type="number" id="quantity-book-${product.id}" value="1" min="1" max="${product.stock > 0 ? product.stock : 1}" class="w-16 p-2.5 border border-slate-300 rounded-lg text-center form-input" ${product.stock === 0 ? 'disabled' : ''}>
                                <button class="quantity-increase" data-target="quantity-book-${product.id}" aria-label="Increase quantity"><i class="fas fa-plus"></i></button>
                            </div>
                            <button class="btn btn-primary w-full sm:w-auto text-base add-to-cart-book-page ${product.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}" data-product-id="${product.id}" ${product.stock === 0 ? 'disabled' : ''}>
                                <i class="fas fa-cart-plus mr-2"></i> Add to Cart
                            </button>
                        </div>
                    </div>
                    <div class="mt-10 pt-6 border-t border-slate-200">
                        <h3 class="detail-section-title">Customer Reviews (${product.reviews ? product.reviews.length : 0})</h3>
                        <div id="book-reviews-container">${reviewsHTML}</div>
                        ${product.reviews && product.reviews.length > 3 ? '<button id="load-more-reviews" class="btn btn-outline text-sm mt-4">Load More Reviews</button>' : ''}
                    </div>
                `;
                Elements.bookDetailContentArea.classList.remove('opacity-0');
                Elements.bookDetailContentArea.classList.add('opacity-100');


                Elements.bookDetailContentArea.querySelector('[data-page="products"]').addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToPage('products');
                });

                Elements.bookDetailContentArea.querySelector('.add-to-cart-book-page').addEventListener('click', (e) => {
                    const quantityInput = document.getElementById(`quantity-book-${product.id}`);
                    const quantity = parseInt(quantityInput.value);
                    addToCart(product.id, quantity);
                    animateElement(e.currentTarget, 'animate-pulseShort', true, 300); // Corrected class name
                });
                setupQuantityControls(Elements.bookDetailContentArea);
                observeForAnimation(Elements.bookDetailContentArea.querySelectorAll('[data-animate-on-scroll]'));
            }

            // --- Quantity Controls ---
            function setupQuantityControls(parentElement = document) {
                parentElement.querySelectorAll('.quantity-decrease').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const targetInputId = e.currentTarget.dataset.target;
                        const input = parentElement.getElementById(targetInputId);
                        if (input) {
                            let currentValue = parseInt(input.value);
                            if (currentValue > input.min) {
                                input.value = currentValue - 1;
                                input.dispatchEvent(new Event('change', { bubbles: true })); // Trigger change for cart updates
                            }
                        }
                    });
                });
                parentElement.querySelectorAll('.quantity-increase').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const targetInputId = e.currentTarget.dataset.target;
                        const input = parentElement.getElementById(targetInputId);
                        if (input) {
                            let currentValue = parseInt(input.value);
                            if (currentValue < input.max) { // Check against input.max directly
                                input.value = currentValue + 1;
                                input.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }
                    });
                });
            }


            // --- Wishlist Functionality ---
            function toggleWishlist(productId, buttonElement) {
                const productIndex = wishlist.indexOf(productId);
                const product = sampleProducts.find(p => p.id === productId);
                if (!product) return;

                if (productIndex > -1) {
                    wishlist.splice(productIndex, 1);
                    if (buttonElement) {
                        buttonElement.classList.remove('active');
                        buttonElement.title = 'Add to Wishlist';
                        buttonElement.setAttribute('aria-pressed', 'false');
                    }
                    showToast(`${product.name} removed from wishlist.`, 'info');
                } else {
                    wishlist.push(productId);
                     if (buttonElement) {
                        buttonElement.classList.add('active');
                        buttonElement.title = 'Remove from Wishlist';
                        buttonElement.setAttribute('aria-pressed', 'true');
                    }
                    showToast(`${product.name} added to wishlist!`, 'success');
                }
                localStorage.setItem('proShopWishlistV4', JSON.stringify(wishlist));
                updateAccountWishlistDisplay(); // Update if on account page
                if(Elements.accountWishlistCount) Elements.accountWishlistCount.textContent = wishlist.length;

                // Update all visible wishlist buttons for this product
                document.querySelectorAll(`.wishlist-btn[data-product-id="${productId}"]`).forEach(btn => {
                    btn.classList.toggle('active', wishlist.includes(productId));
                    btn.title = wishlist.includes(productId) ? 'Remove from Wishlist' : 'Add to Wishlist';
                    btn.setAttribute('aria-pressed', wishlist.includes(productId) ? 'true' : 'false');
                });
            }


            // --- Cart Functionality ---
            function addToCart(productId, quantity = 1) {
                const product = sampleProducts.find(p => p.id === productId);
                if (!product) { showToast('Product not found.', 'error'); return; }
                if (product.stock === 0) { showToast(`${product.name} is out of stock.`, 'error'); return; }

                const existingItem = cart.find(item => item.id === productId);
                let actualQuantityAdded = quantity;

                if (existingItem) {
                    if (existingItem.quantity + quantity <= product.stock) {
                       existingItem.quantity += quantity;
                    } else {
                        actualQuantityAdded = product.stock - existingItem.quantity;
                        existingItem.quantity = product.stock;
                        if (actualQuantityAdded > 0) {
                           showToast(`Max stock for ${product.name} reached. Added ${actualQuantityAdded}.`, 'warning');
                        } else {
                           showToast(`Max stock for ${product.name} already in cart.`, 'info');
                           return; // Don't show "added to cart" if nothing was added
                        }
                    }
                } else {
                    if (quantity <= product.stock) {
                        cart.push({ ...product, quantity: quantity });
                    } else {
                         actualQuantityAdded = product.stock;
                         cart.push({ ...product, quantity: product.stock });
                         showToast(`Only ${product.stock} of ${product.name} available. Added ${actualQuantityAdded}.`, 'warning');
                    }
                }
                updateCart();
                showToast(`${product.name} (x${actualQuantityAdded}) added to cart!`, 'success');
                // Animate cart icon
                if (Elements.cartItemCountEl) {
                    Elements.cartItemCountEl.classList.add('transform', 'scale-125', 'bg-green-500');
                    setTimeout(() => Elements.cartItemCountEl.classList.remove('scale-125', 'bg-green-500'), 300);
                }
            }

            function updateCartQuantity(productId, newQuantity) {
                const itemIndex = cart.findIndex(item => item.id === productId);
                if (itemIndex > -1) {
                    const product = sampleProducts.find(p => p.id === productId);
                    if (!product) return; // Should not happen

                    if (newQuantity > 0 && newQuantity <= product.stock) {
                        cart[itemIndex].quantity = newQuantity;
                    } else if (newQuantity <= 0) {
                        // removeFromCart will handle toast
                        removeFromCart(productId); 
                        return; // Avoid double updateCart call
                    } else if (newQuantity > product.stock) {
                        cart[itemIndex].quantity = product.stock;
                        showToast(`Only ${product.stock} of ${cart[itemIndex].name} available. Quantity adjusted.`, 'warning');
                    }
                }
                updateCart();
            }

            function removeFromCart(productId) {
                const itemIndex = cart.findIndex(item => item.id === productId);
                if (itemIndex === -1) return;

                const removedItem = cart[itemIndex];
                cart.splice(itemIndex, 1);
                
                // Animate removal in UI before re-rendering
                const cartItemRow = Elements.cartItemsContainer.querySelector(`li[data-cart-item-id="${productId}"]`);
                if (cartItemRow) {
                    cartItemRow.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    cartItemRow.style.opacity = '0';
                    cartItemRow.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        updateCart(); // This will re-render the cart items
                        showToast(`${removedItem.name} removed from cart.`, 'info');
                    }, 300);
                } else {
                    updateCart();
                    showToast(`${removedItem.name} removed from cart.`, 'info');
                }
            }
            
            function applyPromoCode() {
                const code = Elements.promoCodeInput.value.toUpperCase().trim();
                if (!code) {
                    Elements.promoFeedbackEl.textContent = "Please enter a code.";
                    Elements.promoFeedbackEl.className = 'text-xs mt-1.5 text-amber-600';
                    return;
                }
                const promo = PROMO_CODES[code];
                if (promo) {
                    appliedPromoCode = { code, ...promo };
                    Elements.promoFeedbackEl.textContent = `Code "${code}" applied!`;
                    Elements.promoFeedbackEl.className = 'text-xs mt-1.5 text-green-600';
                    showToast(`Promo code "${code}" applied!`, 'success');
                } else {
                    appliedPromoCode = null;
                    Elements.promoFeedbackEl.textContent = "Invalid promo code.";
                    Elements.promoFeedbackEl.className = 'text-xs mt-1.5 text-red-500';
                    showToast('Invalid promo code.', 'error');
                }
                Elements.promoCodeInput.value = ''; // Clear input
                updateCartSummaryAndIcon(); // Recalculate totals
            }
            if (Elements.applyPromoBtn) Elements.applyPromoBtn.addEventListener('click', applyPromoCode);
            if (Elements.promoCodeInput) Elements.promoCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyPromoCode();
                }
            });


            function updateCart() {
                localStorage.setItem('proShopCartV4', JSON.stringify(cart));
                renderCartItems();
                updateCartSummaryAndIcon(); // This will also call renderCheckoutOrderSummary
            }

            function renderCartItems() {
                if (!Elements.cartItemsContainer || !Elements.cartEmptyMessage || !Elements.cartSummaryEl || !Elements.cartSummaryContainer) return;

                Elements.cartItemsContainer.innerHTML = ''; // Clear current items
                if (cart.length === 0) {
                    Elements.cartItemsContainer.appendChild(Elements.cartEmptyMessage);
                    Elements.cartEmptyMessage.style.display = 'block';
                    Elements.cartSummaryEl.classList.add('hidden');
                    Elements.cartSummaryContainer.classList.add('lg:hidden'); // Hide summary on large screens if cart is empty
                    if (Elements.proceedCheckoutBtn) Elements.proceedCheckoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    return;
                }

                Elements.cartEmptyMessage.style.display = 'none';
                Elements.cartSummaryEl.classList.remove('hidden');
                Elements.cartSummaryContainer.classList.remove('lg:hidden');
                if (Elements.proceedCheckoutBtn) Elements.proceedCheckoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');


                const ul = document.createElement('ul');
                ul.className = 'divide-y divide-slate-200';
                cart.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'py-5 flex flex-col sm:flex-row items-start sm:items-center sm:justify-between space-y-3 sm:space-y-0 sm:space-x-4 transition-all duration-300 ease-in-out';
                    li.dataset.cartItemId = item.id; // For animation
                    li.innerHTML = `
                        <div class="flex items-center space-x-4 flex-grow">
                            <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded-lg shadow" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/100x100/E2E8F0/94A3B8?text=No+Img';">
                            <div>
                                <h4 class="text-md font-semibold text-slate-800 hover:text-indigo-600 cursor-pointer view-details-cart" data-product-id="${item.id}">${item.name}</h4>
                                <p class="text-sm text-slate-500">${formatPrice(item.price)} each</p>
                                <button class="text-xs text-red-500 hover:text-red-700 hover:underline remove-from-cart-btn mt-1 font-medium" data-product-id="${item.id}">
                                    <i class="fas fa-trash-alt mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 w-full sm:w-auto justify-between sm:justify-end">
                            <div class="flex items-center quantity-control">
                                <label for="cart-quantity-${item.id}" class="sr-only">Quantity for ${item.name}</label>
                                <button class="quantity-decrease" data-target="cart-quantity-${item.id}" aria-label="Decrease quantity of ${item.name}"><i class="fas fa-minus text-xs"></i></button>
                                <input type="number" id="cart-quantity-${item.id}" value="${item.quantity}" min="1" max="${item.stock}" data-product-id="${item.id}" class="cart-item-quantity w-12 p-1.5 border-y border-slate-300 text-center text-sm form-input focus:ring-1 focus:ring-indigo-500">
                                <button class="quantity-increase" data-target="cart-quantity-${item.id}" aria-label="Increase quantity of ${item.name}"><i class="fas fa-plus text-xs"></i></button>
                            </div>
                            <p class="text-md font-semibold text-slate-700 w-24 text-right">${formatPrice(item.price * item.quantity)}</p>
                        </div>
                    `;
                    ul.appendChild(li);
                });
                Elements.cartItemsContainer.appendChild(ul);
                setupQuantityControls(Elements.cartItemsContainer);

                Elements.cartItemsContainer.querySelectorAll('.cart-item-quantity').forEach(input => {
                    input.addEventListener('change', (e) => updateCartQuantity(parseInt(e.target.dataset.productId), parseInt(e.target.value)));
                });
                Elements.cartItemsContainer.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                    button.addEventListener('click', (e) => removeFromCart(parseInt(e.currentTarget.dataset.productId)));
                });
                Elements.cartItemsContainer.querySelectorAll('.view-details-cart').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = parseInt(e.currentTarget.dataset.productId);
                        const product = sampleProducts.find(p => p.id === productId);
                        if (product && product.category === "Books") {
                            navigateToPage('book-detail-page', { productId: productId });
                        } else {
                            showProductDetailModal(productId);
                        }
                    });
                });
            }

            function updateCartSummaryAndIcon() {
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let discountAmount = 0;

                if (appliedPromoCode) {
                    if (appliedPromoCode.type === "percentage") {
                        discountAmount = (subtotal * appliedPromoCode.value) / 100;
                    } else if (appliedPromoCode.type === "fixed") {
                        discountAmount = appliedPromoCode.value;
                    }
                    // Ensure discount doesn't exceed subtotal
                    discountAmount = Math.min(discountAmount, subtotal);

                    Elements.discountAppliedRow.style.display = 'flex';
                    Elements.cartDiscountAmountEl.textContent = `-${formatPrice(discountAmount)}`;
                    Elements.discountCodeAppliedEl.textContent = appliedPromoCode.code;
                    
                    if (Elements.checkoutDiscountRow) Elements.checkoutDiscountRow.style.display = 'flex';
                    if (Elements.checkoutDiscountAmountEl) Elements.checkoutDiscountAmountEl.textContent = `-${formatPrice(discountAmount)}`;

                } else {
                    Elements.discountAppliedRow.style.display = 'none';
                    if (Elements.checkoutDiscountRow) Elements.checkoutDiscountRow.style.display = 'none';
                }


                const total = Math.max(0, subtotal - discountAmount); // Ensure total is not negative

                if (Elements.cartSubtotalEl) Elements.cartSubtotalEl.textContent = formatPrice(subtotal);
                if (Elements.cartTotalEl) Elements.cartTotalEl.textContent = formatPrice(total);
                if (Elements.checkoutSubtotalEl) Elements.checkoutSubtotalEl.textContent = formatPrice(subtotal);
                if (Elements.checkoutTotalEl) Elements.checkoutTotalEl.textContent = formatPrice(total);

                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                if (Elements.cartItemCountEl) {
                    Elements.cartItemCountEl.textContent = totalItems;
                    Elements.cartItemCountEl.classList.toggle('hidden', totalItems === 0);
                }
                if (Elements.cartSummaryItemCountEl) Elements.cartSummaryItemCountEl.textContent = totalItems;


                renderCheckoutOrderSummary(); // Update checkout summary whenever cart changes
            }

            // --- Checkout Page & Thank You Page ---
            function renderCheckoutOrderSummary() {
                 if (!Elements.checkoutOrderSummary) return;
                Elements.checkoutOrderSummary.innerHTML = '';
                if (cart.length === 0) {
                    Elements.checkoutOrderSummary.innerHTML = '<p class="text-slate-500 py-4 text-center">Your cart is empty. Add items to proceed.</p>';
                    return;
                }
                const ul = document.createElement('ul');
                ul.className = 'space-y-2.5 text-sm divide-y divide-slate-100'; // Slightly more space
                cart.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center pt-2.5 first:pt-0';
                    li.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md shadow-sm" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/48x48/E2E8F0/94A3B8?text=Img';">
                            <div>
                                <span class="font-medium text-slate-700 block leading-tight">${item.name}</span>
                                <span class="block text-xs text-slate-500">Qty: ${item.quantity} &times; ${formatPrice(item.price)}</span>
                            </div>
                        </div>
                        <span class="font-semibold text-slate-800">${formatPrice(item.price * item.quantity)}</span>
                    `;
                    ul.appendChild(li);
                });
                Elements.checkoutOrderSummary.appendChild(ul);
            }
            
            function validateCheckoutForm() {
                let isValid = true;
                const requiredFields = ['first-name', 'last-name', 'email', 'address', 'city', 'zip']; // Add more as needed
                
                requiredFields.forEach(id => {
                    const input = document.getElementById(id);
                    const errorEl = document.getElementById(`${id}Error`) || document.getElementById(id.replace('-','').toLowerCase() + 'Error');

                    if (input && !input.value.trim()) {
                        isValid = false;
                        input.classList.add('border-red-500');
                        if (errorEl) errorEl.classList.remove('hidden');
                    } else if (input) {
                        input.classList.remove('border-red-500');
                         if (errorEl) errorEl.classList.add('hidden');
                         // Specific validation for email
                        if (id === 'email' && !/^\S+@\S+\.\S+$/.test(input.value.trim())) {
                            isValid = false;
                            input.classList.add('border-red-500');
                            if (errorEl) {
                                errorEl.textContent = "Please enter a valid email address.";
                                errorEl.classList.remove('hidden');
                            }
                        }
                    }
                });
                return isValid;
            }


            if (Elements.shippingForm) {
                Elements.shippingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!validateCheckoutForm()) {
                        showToast('Please fill all required fields correctly.', 'error');
                        const firstErrorField = Elements.shippingForm.querySelector('.border-red-500');
                        if (firstErrorField) firstErrorField.focus();
                        return;
                    }

                    if (cart.length === 0) {
                        showToast('Your cart is empty. Cannot place order.', 'error');
                        navigateToPage('cart');
                        return;
                    }
                    
                    const placeOrderText = Elements.placeOrderBtn.querySelector('.place-order-text');
                    const placeOrderLoader = Elements.placeOrderBtn.querySelector('.place-order-loader');
                    placeOrderText.classList.add('hidden');
                    placeOrderLoader.classList.remove('hidden');
                    Elements.placeOrderBtn.disabled = true;

                    // Simulate API call for placing order
                    await new Promise(resolve => setTimeout(resolve, 1500));


                    const formData = new FormData(Elements.shippingForm);
                    const orderData = Object.fromEntries(formData);
                    const paymentMethod = orderData.payment; // 'card', 'paypal', 'cod'
                    
                    const totalAmount = parseFloat(Elements.checkoutTotalEl.textContent.replace('$', ''));

                    // Populate Thank You page
                    if(Elements.thankYouEmailEl) Elements.thankYouEmailEl.textContent = orderData.email || 'your.email@example.com';
                    if(Elements.thankYouOrderIdEl) Elements.thankYouOrderIdEl.textContent = `#PRO${Date.now().toString().slice(-7)}`;
                    if(Elements.thankYouOrderDateEl) Elements.thankYouOrderDateEl.textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    if(Elements.thankYouOrderTotalEl) Elements.thankYouOrderTotalEl.textContent = formatPrice(totalAmount);
                    if(Elements.thankYouPaymentMethodEl) {
                        let paymentMethodText = "Credit Card";
                        if(paymentMethod === 'paypal') paymentMethodText = "PayPal";
                        else if (paymentMethod === 'cod') paymentMethodText = "Cash on Delivery";
                        Elements.thankYouPaymentMethodEl.textContent = paymentMethodText;
                    }


                    cart = [];
                    appliedPromoCode = null; // Reset promo code
                    localStorage.removeItem('proShopCartV4');
                    updateCart(); // This will update UI, cart icon, clear summaries

                    navigateToPage('thank-you');
                    showToast('Order placed successfully!', 'success');
                    
                    placeOrderText.classList.remove('hidden');
                    placeOrderLoader.classList.add('hidden');
                    Elements.placeOrderBtn.disabled = false;
                    Elements.shippingForm.reset();
                });
            }
            
            if(Elements.paymentRadios) {
                Elements.paymentRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        if (Elements.cardDetailsForm) { // Added null check
                            if (radio.value === 'card' && radio.checked) {
                                Elements.cardDetailsForm.style.display = 'block';
                            } else {
                                Elements.cardDetailsForm.style.display = 'none';
                            }
                        }
                    });
                });
            }

            // --- Toast Notifications ---
            let toastTimeout;
            function showToast(message, type = 'success', duration = 3500) {
                if (!Elements.toastNotification || !Elements.toastMessage) return;
                Elements.toastMessage.textContent = message;
                Elements.toastNotification.className = 'fixed bottom-8 right-8 px-6 py-4 rounded-xl shadow-xl text-white text-sm font-medium z-[200] transition-all duration-500 ease-in-out transform'; // Reset classes

                switch (type) {
                    case 'error': Elements.toastNotification.classList.add('bg-red-600'); break;
                    case 'warning': Elements.toastNotification.classList.add('bg-amber-500'); break;
                    case 'info': Elements.toastNotification.classList.add('bg-sky-600'); break; // Changed to sky
                    default: Elements.toastNotification.classList.add('bg-green-600');
                }
                Elements.toastNotification.classList.add('show');
                clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    Elements.toastNotification.classList.remove('show');
                     // Ensure it's fully hidden before next use
                    setTimeout(() => { 
                        if(Elements.toastNotification) Elements.toastNotification.style.transform = 'translateX(120%) translateY(0)';
                    }, 500);
                }, duration);
            }

            // --- Contact Form ---
            if(Elements.contactForm) {
                Elements.contactForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const sendBtn = document.getElementById('send-message-btn');
                    const sendText = sendBtn.querySelector('.send-message-text');
                    const sendLoader = sendBtn.querySelector('.send-message-loader');

                    sendText.classList.add('hidden');
                    sendLoader.classList.remove('hidden');
                    sendBtn.disabled = true;

                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    console.log('Contact form submitted:', Object.fromEntries(new FormData(Elements.contactForm)));
                    showToast('Message sent! We\'ll be in touch soon.', 'success');
                    Elements.contactForm.reset();

                    sendText.classList.remove('hidden');
                    sendLoader.classList.add('hidden');
                    sendBtn.disabled = false;
                });
            }
            
             // --- Newsletter Form ---
            if (Elements.newsletterForm) {
                Elements.newsletterForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const emailInput = document.getElementById('newsletter-email');
                    if (emailInput && emailInput.value && emailInput.value.includes('@')) {
                        showToast(`Thanks for subscribing, ${emailInput.value}!`, 'success');
                        emailInput.value = '';
                    } else {
                        showToast('Please enter a valid email address.', 'error');
                    }
                });
            }

            // --- Account Page Tabs & Wishlist ---
            if (Elements.accountNavLinks) {
                Elements.accountNavLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabId = link.dataset.accountTab;
                        if (!tabId) { // For logout or other non-tab links
                            if (link.id === 'logout-btn') {
                                console.log("Logout clicked"); // Placeholder for actual logout logic
                                showToast("Logged out successfully (simulated).", "info");
                                navigateToPage('home'); // Redirect to home after logout
                            }
                            return;
                        }

                        Elements.accountNavLinks.forEach(l => l.classList.remove('active', 'bg-indigo-100', 'text-indigo-700', 'font-semibold', 'border-l-4', 'border-indigo-600'));
                        link.classList.add('active', 'bg-indigo-100', 'text-indigo-700', 'font-semibold', 'border-l-4', 'border-indigo-600');
                        
                        Elements.accountTabContents.forEach(content => content.classList.add('hidden'));
                        const activeContent = document.getElementById(`account-content-${tabId}`);
                        if (activeContent) {
                            activeContent.classList.remove('hidden');
                            // Animate content appearance
                            activeContent.style.opacity = '0';
                            activeContent.style.transform = 'translateY(10px)';
                            setTimeout(() => {
                                activeContent.style.opacity = '1';
                                activeContent.style.transform = 'translateY(0)';
                                activeContent.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                            }, 50);

                            if (tabId === 'my-wishlist') {
                                updateAccountWishlistDisplay();
                            }
                        }
                    });
                });
            }
            
            function updateAccountWishlistDisplay() {
                if (!Elements.accountWishlistItems) return;
                Elements.accountWishlistItems.innerHTML = '';
                if (wishlist.length === 0) {
                    Elements.accountWishlistItems.innerHTML = '<p class="text-slate-500">Your wishlist is empty. <a href="#products" data-page="products" class="text-indigo-600 hover:underline">Browse products</a> to add some!</p>';
                    return;
                }
                const ul = document.createElement('ul');
                ul.className = 'space-y-4';
                wishlist.forEach(productId => {
                    const product = sampleProducts.find(p => p.id === productId);
                    if (product) {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:shadow-sm transition-shadow';
                        li.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <img src="${product.image}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md">
                                <div>
                                    <a href="${product.category === 'Books' ? `#book/${product.id}` : '#'}" data-page="${product.category === 'Books' ? 'book-detail-page' : 'products'}" data-product-id="${product.id}" class="font-semibold text-slate-700 hover:text-indigo-600 product-link-from-wishlist">${product.name}</a>
                                    <p class="text-sm text-slate-500">${formatPrice(product.price)}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="btn btn-primary btn-sm text-xs add-to-cart-from-wishlist ${product.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}" data-product-id="${product.id}" ${product.stock === 0 ? 'disabled' : ''}><i class="fas fa-cart-plus mr-1"></i> Cart</button>
                                <button class="btn btn-danger btn-sm text-xs remove-from-wishlist-page" data-product-id="${product.id}"><i class="fas fa-times mr-1"></i> Remove</button>
                            </div>
                        `;
                        ul.appendChild(li);
                    }
                });
                Elements.accountWishlistItems.appendChild(ul);

                // Add event listeners for new buttons
                Elements.accountWishlistItems.querySelectorAll('.add-to-cart-from-wishlist').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        addToCart(parseInt(e.currentTarget.dataset.productId));
                    });
                });
                Elements.accountWishlistItems.querySelectorAll('.remove-from-wishlist-page').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        toggleWishlist(parseInt(e.currentTarget.dataset.productId), null); // No specific button element to update here, re-render handles it
                    });
                });
                 Elements.accountWishlistItems.querySelectorAll('.product-link-from-wishlist').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const productId = parseInt(link.dataset.productId);
                        const product = sampleProducts.find(p => p.id === productId);
                        if (product) {
                            if (product.category === 'Books') {
                                navigateToPage('book-detail-page', { productId: productId });
                            } else {
                                // If we want to show modal, need to ensure it's available or navigate to product page
                                showProductDetailModal(productId);
                            }
                        }
                    });
                });
            }
            

            // --- Confetti for Thank You Page ---
            function createConfetti() {
                if (!Elements.confettiContainer) return;
                Elements.confettiContainer.innerHTML = ''; // Clear old confetti
                const confettiCount = 100;
                const colors = ['#6366F1', '#EC4899', '#10B981', '#F59E0B', '#3B82F6']; // Indigo, Pink, Green, Amber, Blue
                for (let i = 0; i < confettiCount; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti-piece');
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = Math.random() * -50 + 'vh'; // Start above screen
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.setProperty('--random-x', (Math.random() - 0.5) * 2); // For horizontal sway
                    confetti.style.setProperty('--random-rot', Math.random() * 360); // For rotation
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    Elements.confettiContainer.appendChild(confetti);
                }
            }
            // Add CSS for confetti
            const confettiStyle = document.createElement('style');
            confettiStyle.innerHTML = `
                .confetti-piece {
                    position: absolute;
                    width: 10px;
                    height: 20px;
                    opacity: 0;
                    transform-origin: center;
                    animation: fall 4s linear infinite;
                }
                @keyframes fall {
                    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                    100% { transform: translateY(120vh) rotate(calc(var(--random-rot) * 1deg)) translateX(calc(var(--random-x) * 100px)); opacity: 0; }
                }
                /* Simple pulse animation for buttons */
                @keyframes pulseShort { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
                .animate-pulseShort { animation: pulseShort 0.3s ease-out; }

            `;
            document.head.appendChild(confettiStyle);

            // --- Intersection Observer for animations ---
            function observeForAnimation(elementsToObserve) {
                if (!('IntersectionObserver' in window)) { // Fallback for older browsers
                    elementsToObserve.forEach(el => {
                        el.style.opacity = '1'; // Just make them visible
                        el.classList.add('product-card-animated'); // Apply static animation class if needed
                    });
                    return;
                }

                const observer = new IntersectionObserver((entries, obs) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.style.opacity = '1'; // Make it visible
                            entry.target.classList.add('product-card-animated'); 
                            if (entry.target.classList.contains('review-card')) {
                                entry.target.style.transform = 'translateY(0)';
                            }
                            obs.unobserve(entry.target); 
                        }
                    });
                }, { threshold: 0.1 }); 

                elementsToObserve.forEach(el => {
                     el.style.opacity = '0'; 
                     if (el.classList.contains('review-card')) { 
                         el.style.transform = 'translateY(20px)';
                         el.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                     }
                    observer.observe(el);
                });
            }
            if (Elements.currentYearEl) Elements.currentYearEl.textContent = new Date().getFullYear();
            
            handleHashChange(); 
            updateCart(); 
            setupQuantityControls();
            setTimeout(() => {
                if (document.getElementById('home')?.classList.contains('active')) {
                     observeForAnimation(document.querySelectorAll('#home [data-animate-on-scroll]'));
                }
            }, 100); 
        });
    </script>
</body>
</html>